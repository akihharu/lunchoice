<div class="history-container">
  <h2><%= current_user.name %> さんのランチ記録</h2>

  <div class="graph-section mb-5">
    <h3 class="section-title text-center">
      <i class="bi bi-pie-chart-fill me-2"></i>ランチ統計（料理別割合）
    </h3>
    <div class="chart-wrapper shadow-sm">
      <% if @chart_data.present? %>
        <canvas id="lunchChart"></canvas>
      <% else %>
        <p class="no-data-text text-center text-muted">記録が増えるとここにグラフが表示されます</p>
      <% end %>
    </div>
  </div>
  <hr class="my-5">

  <% if @choices.any? %>
    <p class="record-count text-center">これまでに <strong><%= @choices.count %></strong> 件のランチを記録しました。</p>
    
    <ul class="history-list">
      <% @choices.each do |choice| %>
        <li class="history-item">
          <div class="dish-info">
            <span class="dish-name"><%= choice.dish.name %></span>
            <span class="details">(<%= choice.cuisin_at_choice %>・<%= choice.main_dish_at_choice %>)</span>
          </div>
          <div class="record-date">
            <%= choice.created_at.strftime("%Y年%m月%d日 %H:%M") %>
          </div>
        </li>
      <% end %>
    </ul>
  <% else %>
    <div class="no-history text-center">
      <p>まだランチの記録がありません。</p>
      <%= link_to 'ランチを選択する', new_choice_path, class: 'btn-select' %>
    </div>
  <% end %>

  <div class="actions text-center mt-4">
    <%= link_to 'トップページに戻る', root_path, class: 'btn-back' %>
  </div>
</div>

<script>
  (function() {
    const drawChart = () => {
      const canvas = document.getElementById('lunchChart');
      if (!canvas) return;

      if (typeof Chart === 'undefined') return;

      const existing = Chart.getChart(canvas);
      if (existing) existing.destroy();

      new Chart(canvas, {
        type: 'pie',
        data: {
          labels: <%= raw @chart_labels.to_json %>,
          datasets: [{
            data: <%= @chart_data.to_json %>,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    };

    document.addEventListener('turbo:load', drawChart);
    
    if (document.readyState !== 'loading') {
      drawChart();
    } else {
      document.addEventListener('DOMContentLoaded', drawChart);
    }
  })();
</script>