<div class="selection-container">
  <h2>今日の昼食、何にする？</h2>
  <p>大カテゴリと主食を選択して、候補を提案してもらいましょう！</p>
  
  <%= form_with url: dishes_path, method: :get, local: true, class: "selection-form" do %>

    <div class="category-group">
      <h3>1. 大カテゴリ</h3>
      <% ['和食', '洋食', '中華'].each do |cuisine| %>
        <% id = "cuisine_#{cuisine}" %> 
        
        <%= radio_button_tag :cuisine, cuisine, false, id: id, class: "cuisine-radio" %>
        
        <label for="<%= id %>" class="radio-label">
          <%= cuisine %>
        </label>
      <% end %>
    </div>
    
    <div class="category-group">
      <h3>2. 主食</h3>
      <% ['米', '麺', 'その他'].each do |main_dish| %>
        <% id = "main_dish_#{main_dish}" %> 
    
        <%= radio_button_tag :main_dish, main_dish, false, id: id, class: "main-dish-radio" %>
        
        <label for="<%= id %>" class="radio-label <%= 'option-disabled' if main_dish == 'その他' %>">
          <%= main_dish %>
        </label>
      <% end %>
    </div>
    <div class="actions">
      <%= submit_tag "提案", class: "btn-submit", disabled: true %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('turbo:load', initializeChoiceSelection);
document.addEventListener('turbolinks:load', initializeChoiceSelection);
document.addEventListener('DOMContentLoaded', initializeChoiceSelection);

function initializeChoiceSelection() {
  const cuisineRadios = document.querySelectorAll('.cuisine-radio');
  const otherMainDishLabel = document.querySelector('.option-disabled');
  const otherMainDishInput = document.querySelector('#main_dish_その他');
  const mainDishRadios = document.querySelectorAll('.main-dish-radio');
  const submitButton = document.querySelector('.btn-submit');    

  function checkFormValidity() {
    let cuisineSelected = Array.from(cuisineRadios).some(radio => radio.checked);
    let mainDishSelected = Array.from(mainDishRadios).some(radio => radio.checked);

    if (cuisineSelected && mainDishSelected) {
      submitButton.disabled = false;
      submitButton.style.opacity = '1.0';
    } else {
      submitButton.disabled = true;
      submitButton.style.opacity = '0.6';
    }
  }
  
  function handleChukaDisable(radio) {
    if (radio.value === '中華' && radio.checked) {
      if (otherMainDishInput) {
        otherMainDishInput.disabled = true;
      }
      if (otherMainDishLabel) {
        otherMainDishLabel.style.opacity = '0.5';
        otherMainDishLabel.style.pointerEvents = 'none';
        otherMainDishLabel.style.cursor = 'not-allowed';
      }
      if (otherMainDishInput && otherMainDishInput.checked) {
        otherMainDishInput.checked = false;
      }
    } else {
      if (otherMainDishInput) {
        otherMainDishInput.disabled = false;
      }
      if (otherMainDishLabel) {
        otherMainDishLabel.style.opacity = '1.0';
        otherMainDishLabel.style.pointerEvents = 'auto';
        otherMainDishLabel.style.cursor = 'pointer';
      }
    }
  }

  cuisineRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      handleChukaDisable(this);
      checkFormValidity();
    });
  });
  
  mainDishRadios.forEach(radio => {
    radio.addEventListener('change', checkFormValidity);
  });

  cuisineRadios.forEach(radio => handleChukaDisable(radio));
  checkFormValidity();
}
</script>